# 012: パフォーマンス最適化

## 概要
ページ読み込み時間短縮とユーザー体験向上のための最適化

## 優先度
🟡 高

## 見積もり時間
6時間

## Phase
Phase 2 - β版

## 詳細仕様

### パフォーマンス目標
| 項目               | 目標値          |
|--------------------|-----------------|
| ページ読み込み時間 | 3秒以内         |
| 地図初期表示       | 2秒以内         |
| APIレスポンス      | 1秒以内         |
| First Contentful Paint (FCP) | 1.8秒以内 |
| Largest Contentful Paint (LCP) | 2.5秒以内 |
| Cumulative Layout Shift (CLS) | 0.1以下 |

### 最適化項目

#### 1. 画像最適化
- WebP形式使用
- 遅延読み込み
- レスポンシブ画像
- blur placeholder

#### 2. コード分割
- 動的インポート
- ルートベースコード分割
- コンポーネント遅延読み込み

#### 3. キャッシング
- Redis導入（検討）
- SWR/React Queryでクライアントキャッシング
- Service Workerでオフライン対応

#### 4. データベース最適化
- インデックス最適化
- クエリパフォーマンス改善
- コネクションプーリング

#### 5. CDN活用
- Vercel Edge Network
- 静的アセットのキャッシング

## 実装タスク

- [ ] Lighthouse監査実施
  - [ ] 現状のスコア測定
  - [ ] 改善点の特定
- [ ] 画像最適化
  - [ ] すべてWebP形式に変換
  - [ ] Next.js Imageコンポーネント使用徹底
  - [ ] 遅延読み込み設定
  - [ ] blur placeholder生成
- [ ] コード分割
  - [ ] 動的インポート適用（地図、モーダルなど）
  - [ ] バンドルサイズ分析（`@next/bundle-analyzer`）
  - [ ] 不要な依存関係削除
- [ ] クライアント側キャッシング
  - [ ] SWR導入
  - [ ] キャッシュ戦略設定
  - [ ] 再検証ロジック実装
- [ ] データベース最適化
  - [ ] クエリ分析（`EXPLAIN ANALYZE`）
  - [ ] インデックス追加
  - [ ] N+1問題解消
- [ ] フォント最適化
  - [ ] `next/font`使用
  - [ ] サブセット化
  - [ ] FOIT/FOUT対策
- [ ] Service Worker導入（PWA対応）
  - [ ] オフライン対応
  - [ ] キャッシュ戦略
- [ ] パフォーマンスモニタリング
  - [ ] Vercel Analytics設定
  - [ ] Core Web Vitals追跡
  - [ ] エラートラッキング（Sentry検討）
- [ ] 再測定と改善
  - [ ] Lighthouse再測定
  - [ ] PageSpeed Insights確認
  - [ ] 実機テスト

## 関連ファイル
- `next.config.ts` (更新)
- `src/app/layout.tsx` (更新)
- `src/lib/swr-config.ts` (作成)
- `public/sw.js` (作成)
- `package.json` (更新)
- `.lighthouserc.json` (作成)

## 完了条件
- [×] Lighthouseスコア90以上
- [×] ページ読み込み時間が3秒以内
- [×] Core Web Vitalsが目標値を達成
- [×] バンドルサイズが最適化されている
- [×] 画像が最適化されている
- [×] キャッシングが適切に動作している

## 備考
- 定期的にパフォーマンス測定を実施
- 新機能追加時は必ずパフォーマンス影響を確認
- ユーザーのネットワーク環境を考慮（3G回線でもテスト）
