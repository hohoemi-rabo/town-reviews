# 010: AI機能（トーン変換・タグ生成・カテゴリー自動分類）

## 概要
OpenAI APIを使用した投稿時のトーン変換、タグ自動生成、カテゴリー自動分類

## 優先度
🟢 中

## 見積もり時間
8時間（カテゴリー自動分類+2時間）

## Phase
Phase 2 - β版

## 詳細仕様

### 1. やさしいトーンへの変換
- **入力**: ユーザーの生メモ
- **出力**: やさしく読みやすい文章
- **ON/OFF**: ユーザーが選択可能
- **モデル**: GPT-4o-mini
- **最大文字数**: 200文字

#### プロンプト例
```
以下の口コミを、温かくて親しみやすいトーンに変換してください。
地域の人々が使うような柔らかい表現を心がけてください。
200文字以内にまとめてください。

元の文章: {user_input}
```

### 2. 自動タグ生成
- **入力**: 投稿内容 + スポット名
- **出力**: タグ配列（最大5個）
- **モデル**: GPT-4o-mini

#### タグカテゴリ
- スポット種類: #カフェ #レストラン #温泉 など
- 特徴: #子連れOK #ペット可 #駐車場あり など
- 雰囲気: #静か #おしゃれ #レトロ など
- 時間帯: #朝活 #ランチ #ディナー など

#### プロンプト例
```
以下のスポット情報と口コミから、適切なタグを最大5個生成してください。
タグは#から始めてください。

スポット名: {spot_name}
口コミ: {note}

タグの例: #カフェ #子連れOK #静か #ランチ #駐車場あり
```

### 3. 不適切コンテンツ検出
- **使用**: OpenAI Moderation API
- **検出項目**:
  - 暴力的表現
  - 差別的表現
  - 性的表現
  - 誹謗中傷
- **処理**: 検出時は投稿をブロック

### 4. 季節タグ自動付与
- 投稿日時から自動判定
- 3月〜5月: #春
- 6月〜8月: #夏
- 9月〜11月: #秋
- 12月〜2月: #冬

### 5. カテゴリー自動分類（新規追加）
- **入力**: 口コミメモ内容
- **出力**: カテゴリー（グルメ、景色、体験、癒し、その他）
- **モデル**: GPT-4o-mini
- **実装方式**: リアルタイム分析 + 手動修正可能

#### カテゴリー定義
- **グルメ**: 食べ物、飲み物、料理、味、メニューに関する口コミ
- **景色**: 景色、絶景、紅葉、桜、星空、自然の美しさに関する口コミ
- **体験**: アクティビティ、遊び、体験、イベントに関する口コミ
- **癒し**: 温泉、リラックス、癒し、ゆったりに関する口コミ
- **その他**: 上記に当てはまらない口コミ

#### プロンプト例
```
あなたは口コミ内容を分析して、適切なカテゴリーに分類するAIです。
以下の5つのカテゴリーのいずれかに分類してください：

1. グルメ - 食べ物、飲み物、料理、味、メニューに関する口コミ
2. 景色 - 景色、絶景、紅葉、桜、星空、自然の美しさに関する口コミ
3. 体験 - アクティビティ、遊び、体験、イベントに関する口コミ
4. 癒し - 温泉、リラックス、癒し、ゆったりに関する口コミ
5. その他 - 上記に当てはまらない口コミ

必ず上記のカテゴリー名（グルメ、景色、体験、癒し、その他）のいずれか1つだけを返答してください。
他の文字は一切含めず、カテゴリー名のみを返してください。
```

#### UI/UX設計
- メモ入力後1秒（デバウンス）でAI分析実行
- AI提案カテゴリーを自動選択 + ハイライト表示
- ユーザーは手動で変更可能
- 分析中はローディング表示
- 10文字未満の場合はスキップ

#### 技術仕様
- API: `/api/ai/categorize` (POST)
- Temperature: 0.3（安定した分類のため低め）
- Max tokens: 10（カテゴリー名のみ）
- エラー時: デフォルトで「その他」を選択
- バリデーション: 返答が5つのカテゴリーに含まれるかチェック

## 実装タスク

- [ ] OpenAI API設定
  - [ ] APIキー設定
  - [ ] クライアント初期化
- [ ] トーン変換API実装（`/api/ai/tone`）
  - [ ] プロンプト設計
  - [ ] GPT-4o-mini呼び出し
  - [ ] レスポンス整形
  - [ ] エラーハンドリング
- [ ] タグ生成API実装（`/api/ai/tags`）
  - [ ] プロンプト設計
  - [ ] タグパース処理
  - [ ] 重複排除
- [ ] Moderation API実装（`/api/ai/moderate`）
  - [ ] コンテンツチェック
  - [ ] 不適切判定
- [ ] 季節タグ自動付与機能
  - [ ] 日付から季節判定
  - [ ] タグ配列に追加
- [ ] カテゴリー自動分類API実装（`/api/ai/categorize`）
  - [ ] プロンプト設計（5カテゴリー分類）
  - [ ] GPT-4o-mini呼び出し（Temperature: 0.3, Max tokens: 10）
  - [ ] バリデーション（カテゴリー名チェック）
  - [ ] エラーハンドリング（デフォルト: その他）
- [ ] UI実装
  - [ ] トーン変換ON/OFFトグル
  - [ ] 変換前/変換後プレビュー
  - [ ] 自動生成タグの表示・編集
  - [ ] カテゴリー自動選択UI（AI提案ハイライト）
  - [ ] カテゴリー手動変更機能
  - [ ] ローディング表示
- [ ] キャッシング機能
  - [ ] 同一内容のリクエスト削減
  - [ ] Redis検討（将来）
- [ ] 使用量モニタリング
  - [ ] API使用量記録
  - [ ] コスト管理

## 関連ファイル
- `src/app/api/ai/tone/route.ts` (作成)
- `src/app/api/ai/tags/route.ts` (作成)
- `src/app/api/ai/moderate/route.ts` (作成)
- `src/app/api/ai/categorize/route.ts` (作成) - **カテゴリー自動分類API**
- `src/lib/openai.ts` (作成)
- `src/lib/season-detector.ts` (作成)
- `src/components/PostModal/ToneToggle.tsx` (作成)
- `src/components/PostModal/TagEditor.tsx` (作成)
- `src/components/PostModal/CategorySelector.tsx` (修正) - **AI提案機能追加**
- `src/components/PostModal/PostModal.tsx` (修正) - **カテゴリーAI分析統合**

## 完了条件
- [ ] トーン変換が正常に動作する
- [ ] タグが適切に生成される
- [ ] 不適切コンテンツが検出される
- [ ] 季節タグが自動付与される
- [ ] カテゴリーが自動分類される（AI提案 + 手動修正可能）
- [ ] UI/UXが直感的
- [ ] エラーハンドリングが適切
- [ ] API使用量が最適化されている

## 備考
- OpenAI APIコストを定期的にモニタリング
- トークン数削減のためプロンプト最適化
- キャッシングでAPI呼び出し削減
- レート制限対応（リトライロジック）

### Phase 1での準備作業（完了済み）
- ✅ データベース: `review_category`カラム追加（CHECK制約付き）
- ✅ UI: CategorySelectorコンポーネント作成（手動選択のみ）
- ✅ API: `/api/recommendations`でreview_category保存対応
- ✅ 表示: ReviewCardにカテゴリーバッジ実装
- ⏳ Phase 2実装時: CategorySelectorにAI提案機能追加、PostModalにリアルタイム分析統合
