# 017: ハッシュタグから文章自動生成機能

## 概要
口コミ投稿の「メモ」欄を、ハッシュタグ選択から自動的に文章を生成する仕様に変更。
ユーザーはタグを選択するだけで読みやすい文章が作成でき、編集も可能。

## 優先度
🟡 高

## 見積もり時間
10時間（Phase 1-4合計）

## Phase
Phase 1.5 - UX改善（既存機能の仕様変更）

## 背景と目的
- **現状**: ユーザーが自由記述で文章を入力（特に高齢者には負担）
- **課題**: 文章を考えるのが面倒、何を書いていいかわからない
- **目的**: タグ選択だけで口コミが投稿できる簡易な仕組み
- **方針**: AIは使わず、テンプレートベースで文章生成

## 詳細仕様

### 基本仕様
1. **使用するタグ**: 既存の24種類のタグシステムを利用
   - 🔴 料理ジャンル (6): 和食、洋食・イタリアン、中華、カフェ・スイーツ、ラーメン・麺類、焼肉・居酒屋
   - 🔵 雰囲気・特徴 (7): 絶景、穴場、人気、静か、賑やか、レトロ、SNS映え
   - 🟣 誰と行く (6): 家族向け、子連れOK、デート向き、一人でも楽しめる、友人と、団体OK
   - 🟢 アクセス・設備 (2): 駐車場あり、バリアフリー
   - 🟠 時間帯 (3): 朝がおすすめ、昼がおすすめ、夜がおすすめ

2. **文章生成ルール**: テンプレートベースで自然な文章を生成
   ```
   例1: [和食] [家族向け] [駐車場あり]
   → 「和食のお店です。家族向けで、駐車場もあります。」

   例2: [絶景] [デート向き] [夜がおすすめ]
   → 「絶景スポットです。デート向きで、夜がおすすめです。」

   例3: [カフェ・スイーツ] [SNS映え] [一人でも楽しめる]
   → 「カフェ・スイーツのお店です。SNS映えする雰囲気で、一人でも楽しめます。」
   ```

3. **ユーザー編集**: 生成後にテキストエリアで自由に編集可能

4. **必須条件**: 最低1つのタグ選択が必須（未選択時はエラー）

5. **既存データ**: 既に投稿された口コミはそのまま保持（新規投稿のみ新仕様）

### UI設計

#### 投稿フォーム（PostModal.tsx）
```
┌─────────────────────────────────────┐
│ タグを選択 *                         │
│ ┌───┐ ┌───┐ ┌───┐                 │
│ │和食│ │家族│ │駐車│ ...           │
│ └───┘ └───┘ └───┘                 │
│                                     │
│ [📝 文章を生成する] ← 新規ボタン     │
│                                     │
│ 口コミ *                            │
│ ┌─────────────────────────────────┐ │
│ │和食のお店です。家族向けで、      │ │
│ │駐車場もあります。                │ │
│ │ ← 生成後、編集可能              │ │
│ └─────────────────────────────────┘ │
│ 500文字まで（残り○○文字）          │
└─────────────────────────────────────┘
```

#### 動作フロー
1. ユーザーがタグを選択（複数選択可）
2. 「文章を生成する」ボタンをクリック
3. 選択されたタグから文章を自動生成
4. テキストエリアに生成結果を表示
5. ユーザーが必要に応じて編集
6. 投稿

### バリデーション
- **タグ選択**: 最低1つ必須
- **文章生成**: タグが未選択の場合、ボタン無効化またはエラー表示
- **テキスト**: 最大500文字（既存仕様を維持）

## Phase別実装計画

### Phase 1: テンプレート生成ロジックの実装 🟢
**優先度**: 最高
**見積もり**: 3時間

#### タスク
- [×] 新規ファイル作成: `src/lib/text-generator.ts`
- [×] タグカテゴリーの定義（型定義）
- [×] カテゴリー別テンプレートルールの実装
  - [×] 料理ジャンル → "○○のお店です"
  - [×] 雰囲気・特徴 → "○○スポットです" / "○○な雰囲気です"
  - [×] 誰と行く → "○○向きです" / "○○でも楽しめます"
  - [×] アクセス・設備 → "○○があります"
  - [×] 時間帯 → "○○がおすすめです"
- [×] `generateTextFromTags(tags: string[]): string` 関数の実装
  - [×] タグのカテゴリー分類
  - [×] カテゴリー別に文章パーツを生成
  - [×] 自然な接続詞で連結（、で区切る、です/ます調）
- [×] エッジケースの処理
  - [×] タグ0個: 空文字列を返す
  - [×] タグ1個: シンプルな文章
  - [×] タグ複数: 接続詞で繋げる
- [×] 手動テスト（コンソールで動作確認）

#### ファイル
- `src/lib/text-generator.ts` (新規作成)

#### テストケース
```typescript
// テストケース例（手動確認）
generateTextFromTags(['和食'])
// → "和食のお店です。"

generateTextFromTags(['和食', '家族向け', '駐車場あり'])
// → "和食のお店です。家族向けで、駐車場もあります。"

generateTextFromTags(['絶景', 'デート向き', '夜がおすすめ'])
// → "絶景スポットです。デート向きで、夜がおすすめです。"

generateTextFromTags(['カフェ・スイーツ', 'SNS映え', '一人でも楽しめる'])
// → "カフェ・スイーツのお店です。SNS映えする雰囲気で、一人でも楽しめます。"
```

#### 完了条件
- [×] `generateTextFromTags()` 関数が正しく動作
- [×] 24種類すべてのタグで適切な文章生成を確認
- [×] 複数タグの組み合わせで自然な文章が生成される

---

### Phase 2: UI実装（投稿フォーム） 🟡
**優先度**: 高
**見積もり**: 4時間

#### タスク
- [×] `PostModal.tsx` の修正
  - [×] 「文章を生成する」ボタンの追加（TagSelectorの下）
  - [×] ボタンクリックで `generateTextFromTags()` を呼び出し
  - [×] 生成結果を `note` stateに設定
  - [×] ローディング状態の表示（生成中...）
- [×] ボタンのスタイリング
  - [×] アイコン: 📝
  - [×] 色: washi-green
  - [×] タグ未選択時は無効化（disabled）
- [×] テキストエリアの動作確認
  - [×] 生成後も編集可能な状態を維持
  - [×] 文字数カウンターが正常に動作
- [×] エラーハンドリング
  - [×] タグ未選択時のエラーメッセージ
  - [×] 生成失敗時のフォールバック

#### ファイル
- `src/components/PostModal/PostModal.tsx` (修正)

#### UIコンポーネント配置
```tsx
{/* Tag selector */}
<TagSelector
  selectedTags={tags}
  onChange={setTags}
  maxTags={3}
/>

{/* 文章生成ボタン - 新規追加 */}
<button
  type="button"
  onClick={handleGenerateText}
  disabled={tags.length === 0 || generating}
  className="..."
>
  {generating ? '生成中...' : '📝 文章を生成する'}
</button>

{/* メモ入力 */}
<textarea
  value={note}
  onChange={(e) => setNote(e.target.value)}
  placeholder="生成ボタンで文章を作成するか、直接入力してください"
  maxLength={500}
/>
```

#### 完了条件
- [×] 「文章を生成する」ボタンが表示される
- [×] タグ選択後、ボタンをクリックすると文章が生成される
- [×] 生成された文章がテキストエリアに表示される
- [×] ユーザーが生成後に編集できる
- [×] タグ未選択時はボタンが無効化される

---

### Phase 3: バリデーション実装 🟡
**優先度**: 中
**見積もり**: 2時間

#### タスク
- [×] タグ選択必須のバリデーション
  - [×] 送信時に `tags.length === 0` をチェック
  - [×] エラーメッセージ表示: "タグを最低1つ選択してください"
- [×] 文章未入力時のバリデーション
  - [×] 現在の `note` 必須チェックを維持
  - [×] エラーメッセージ: "口コミを入力してください"
- [×] 「文章を生成する」ボタンの制御
  - [×] タグ未選択: ボタン無効化（グレーアウト）
  - [×] タグ選択済み: ボタン有効化
  - [×] ホバー時のツールチップ表示（任意）
- [×] エラー表示の改善
  - [×] エラーメッセージの色: 赤
  - [×] 該当フィールドの枠線: 赤
  - [×] Toastでのエラー通知

#### ファイル
- `src/components/PostModal/PostModal.tsx` (修正)

#### バリデーションロジック
```typescript
const handleSubmit = async () => {
  // タグ選択チェック
  if (tags.length === 0) {
    setError('タグを最低1つ選択してください')
    showToast('タグを最低1つ選択してください', 'error')
    return
  }

  // メモ入力チェック
  if (!note.trim()) {
    setError('口コミを入力してください')
    showToast('口コミを入力してください', 'error')
    return
  }

  // 既存のバリデーション続行...
}
```

#### 完了条件
- [×] タグ未選択時に投稿できない
- [×] 適切なエラーメッセージが表示される
- [×] ボタンの有効/無効が正しく切り替わる
- [×] エラー状態が視覚的にわかりやすい

---

### Phase 4: 編集モーダルへの統合 🟢
**優先度**: 中
**見積もり**: 1時間

#### タスク
- [×] `EditModal.tsx` に同様の機能を実装
  - [×] 「文章を生成する」ボタンの追加
  - [×] ボタンクリックで `generateTextFromTags()` を呼び出し
  - [×] 生成結果を `note` stateに設定
- [×] 既存データの扱い
  - [×] 既存の `note` はそのまま表示
  - [×] ユーザーが「文章を生成する」をクリックした場合のみ上書き
  - [×] 確認ダイアログ表示（任意）: "既存の文章を上書きしますか？" - スキップ（シンプルに上書き）
- [×] バリデーションの統一
  - [×] PostModalと同じバリデーションルールを適用

#### ファイル
- `src/components/ReviewCard/EditModal.tsx` (修正)

#### 既存データの扱い
```typescript
const handleGenerateText = () => {
  if (note.trim() && note.trim() !== '') {
    // 既存の文章がある場合、確認ダイアログ（任意）
    if (confirm('既存の文章を上書きしますか？')) {
      const generated = generateTextFromTags(tags)
      setNote(generated)
    }
  } else {
    // 既存の文章がない場合、そのまま生成
    const generated = generateTextFromTags(tags)
    setNote(generated)
  }
}
```

#### 完了条件
- [×] 編集モーダルで「文章を生成する」ボタンが機能する
- [×] 既存データを保持したまま新規生成が可能
- [×] 投稿モーダルと同じUI/UXを提供

---

## 関連ファイル

### 新規作成
- `src/lib/text-generator.ts` - 文章生成ロジック

### 修正
- `src/components/PostModal/PostModal.tsx` - 投稿フォーム
- `src/components/ReviewCard/EditModal.tsx` - 編集モーダル

### 参照（変更なし）
- `src/components/PostModal/TagSelector.tsx` - タグ選択UI
- `src/lib/formatters.ts` - タグカテゴリー情報（参照のみ）

## テスト計画

### 手動テスト項目
- [ ] Phase 1: 各タグパターンで文章生成を確認
  - [ ] 単一タグ
  - [ ] 複数タグ（同一カテゴリー）
  - [ ] 複数タグ（異なるカテゴリー）
  - [ ] すべてのカテゴリーを組み合わせ
- [ ] Phase 2: UI動作確認
  - [ ] ボタンクリックで生成
  - [ ] 生成後の編集
  - [ ] タグ変更後の再生成
- [ ] Phase 3: バリデーション
  - [ ] タグ未選択時の投稿不可
  - [ ] エラーメッセージ表示
- [ ] Phase 4: 編集モーダル
  - [ ] 既存投稿の編集
  - [ ] 新規投稿と同じ動作

### 対応ブラウザ
- [ ] Chrome（最新版）
- [ ] Safari（最新版）
- [ ] モバイル Safari（iOS）
- [ ] モバイル Chrome（Android）

## 完了条件

### Phase 1
- [×] `generateTextFromTags()` 関数が実装されている
- [×] すべてのタグで適切な文章が生成される
- [×] 手動テストで動作確認完了

### Phase 2
- [×] 投稿フォームに「文章を生成する」ボタンが表示される
- [×] ボタンクリックで文章が生成される
- [×] 生成後に編集可能
- [×] タグ未選択時はボタンが無効化

### Phase 3
- [×] タグ未選択時に投稿できない
- [×] 適切なエラーメッセージが表示される
- [×] バリデーションが正常に機能

### Phase 4
- [×] 編集モーダルでも同様に機能する
- [×] 既存データが適切に扱われる

### 全体
- [×] すべてのPhaseのタスクが完了
- [×] 手動テストがすべて通過
- [ ] 本番環境で動作確認完了（デプロイ後に確認）
- [×] ユーザーが簡単に口コミを投稿できる

## 備考

### 今後の拡張予定
- タグの種類を増やす（様子を見て追加）
- より複雑な文章パターンの追加
- カスタムテンプレートの設定（管理者機能）

### 技術的な考慮事項
- AIは使用しない（テンプレートベース）
- 既存のタグシステムをそのまま利用
- データベーススキーマの変更は不要
- 既存データとの互換性を保つ

### ユーザーへの告知
- 新機能リリース時に簡単な使い方ガイドを表示（任意）
- 「文章を生成する」ボタンの横にヘルプアイコン（任意）
